# デバッグモード

cfFormMailerのメール送信に関する問題を調査するためのデバッグモード機能です。

## 概要

デバッグモードを有効にすると、メール送信処理の詳細情報がMODXのイベントログに記録されます。

## 使用方法

### 1. デバッグモードを有効化

設定ファイル（`forms/your_form/config.ini`）に以下の設定を追加または変更します：

```ini
# デバッグモード （0: 無効[デフォルト] / 1: 有効）
debug_mode = 1
```

### 2. フォームを送信

通常通りフォームを送信します。

### 3. イベントログを確認

MODX管理画面の「ツール」→「イベントログ」から、以下のような情報が記録されていることを確認できます：

#### 記録される情報

**管理者宛メール送信時**:
- メール送信処理の開始
- 宛先（To, CC, BCC）
- 件名
- 送信元（From）
- Reply-To アドレス
- 文字コード
- HTMLメールの有効/無効
- 添付ファイルの有無
- 本文のプレビュー（最初の100文字）
- 送信結果（成功/失敗）

**自動返信メール送信時**:
- メール送信処理の開始（または無効/Reply-To未設定）
- 宛先
- 件名
- 送信元
- 送信者名
- 文字コード
- HTMLメールの有効/無効
- 使用したテンプレート
- 添付ファイルの有無
- 本文のプレビュー（最初の100文字）
- 送信結果（成功/失敗）

### 4. ログの確認例

イベントログには以下のような情報が記録されます：

```
[cfFormMailer Debug] 管理者宛メール送信処理を開始
```

```
[cfFormMailer Debug] 管理者宛メール送信を試行
宛先: admin@example.com
CC: manager@example.com
件名: お問い合わせフォームからの送信
送信元: noreply@example.com
Reply-To: user@example.com
文字コード: iso-2022-jp
HTMLメール: 無効
添付ファイル: あり
本文プレビュー: お問い合わせを受け付けました。以下の内容で送信されました...
```

```
[cfFormMailer Debug] 管理者宛メール送信に成功しました
```

```
[cfFormMailer Debug] 自動返信メール送信処理を開始
```

```
[cfFormMailer Debug] 自動返信メール送信を試行
宛先: user@example.com
件名: お問い合わせありがとうございます
送信元: noreply@example.com
送信者名: サイト運営者
文字コード: iso-2022-jp
HTMLメール: 無効
テンプレート: forms/contact/mail_reply.txt
本文プレビュー: お問い合わせいただきありがとうございます。以下の内容で受け付けました...
```

```
[cfFormMailer Debug] 自動返信メール送信に成功しました
```

## トラブルシューティング

### メール送信に失敗する場合

デバッグモードで以下の項目を確認してください：

1. **宛先アドレスの確認**
   - 正しいメールアドレスが設定されているか
   - 複数の宛先がある場合、すべて有効なアドレスか

2. **送信元アドレスの確認**
   - `admin_mail`または`reply_from`が正しく設定されているか
   - ドメインが存在するアドレスを使用しているか

3. **文字コードの確認**
   - `mail_charset`の設定が適切か
   - 件名や本文に使用できない文字が含まれていないか

4. **添付ファイルの確認**
   - 添付ファイルが存在するか
   - ファイルサイズが大きすぎないか

5. **MODXのメール設定確認**
   - MODXのグローバル設定でメール送信が正しく設定されているか
   - SMTPを使用する場合、SMTP設定が正しいか

### エラーログの確認

デバッグモードとは別に、メール送信に失敗した場合は自動的にエラーログに詳細情報が記録されます：

```
メール送信に失敗しました::SMTP Error: Could not connect to SMTP host.
```

このようなエラーが記録されている場合は、MODXのメール設定を確認してください。

## 注意事項

### セキュリティとプライバシー

- **本番環境では必ず無効化してください**
- デバッグログには以下の情報が含まれます：
  - メールアドレス
  - 件名
  - 本文の一部（最初の100文字）
- 個人情報が含まれるため、調査完了後は必ず`debug_mode = 0`に戻してください

### パフォーマンス

- デバッグモードを有効にすると、わずかにパフォーマンスが低下します
- 本番環境では無効化することを推奨します

## 推奨ワークフロー

1. **問題発生時**
   ```ini
   debug_mode = 1  # デバッグモードを有効化
   ```

2. **フォーム送信とログ確認**
   - フォームを送信
   - MODXイベントログで詳細を確認
   - 問題を特定・修正

3. **調査完了後**
   ```ini
   debug_mode = 0  # デバッグモードを無効化（重要！）
   ```

4. **イベントログのクリーンアップ**
   - 必要に応じて、MODXイベントログから古いデバッグログを削除

## 関連ドキュメント

- [インストールガイド](INSTALLATION.md)
- [設定リファレンス](../forms/sample/config.with_comment.ini)
- [トラブルシューティング](../README.md#トラブルシューティング)

---

**バージョン**: v1.7.1+
**最終更新**: 2025-11-24
